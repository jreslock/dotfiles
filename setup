#!/usr/bin/env bash

# This script sets up the environment in a new development container.
# It installs Antidote, zsh, less, unzip, the GitHub CLI (gh), AWS CLI v2,
# AWS Session Manager Plugin, and Git Credential Manager.

# Exit on any error
set -euo pipefail

log() { echo "[$(date -Iseconds)] $*"; }

# Enforce running from the dotfiles repo dir only
if [ "$(basename "$(pwd)")" != "dotfiles" ]; then
  log "Please run from the root of the dotfiles repository"
  exit 1
fi

# Record repository root so later `cd` calls don't break symlink targets
REPO_DIR="$(pwd)"

# Detect OS
OS=$(uname -s | tr '[:upper:]' '[:lower:]')

# Detect if the system is Alpine Linux
if [ -f /etc/alpine-release ]; then
    OS="alpine"
fi

log "Detected OS: $OS"

# Determine machine architecture and related download vars
detect_arch() {
    ARCH=$(uname -m)
    if [ "$ARCH" = "x86_64" ] || [ "$ARCH" = "amd64" ]; then
        AWS_ARCH="x86_64"
        target="64bit"
        ecr_arch="amd64"
    elif [ "$ARCH" = "arm64" ] || [ "$ARCH" = "aarch64" ]; then
        AWS_ARCH="aarch64"
        target="arm64"
        ecr_arch="arm64"
    else
        log "Unsupported architecture: ${ARCH}"
        exit 1
    fi
}

# ------------------------------------------------------------
# uv (Astral)
# ------------------------------------------------------------
log "Installing uv..."
curl -LsSf https://astral.sh/uv/install.sh | sh

# Install Antidote
log "Installing Antidote..."
if [ ! -d "${HOME}/.antidote" ]; then
  git clone --depth=1 https://github.com/mattmc3/antidote.git "${HOME}/.antidote"
  log "Antidote installed successfully"
else
    log "Antidote already installed, updating..."
    cd "${HOME}/.antidote" && git pull --quiet && cd - > /dev/null
fi

# Install zsh
if ! command -v zsh &> /dev/null; then
    log "Installing zsh..."
    if [ "$OS" = "darwin" ]; then
        brew install zsh
    elif [ "$OS" = "alpine" ]; then
        apk add --no-cache zsh
    else
        sudo apt update -yqq
        sudo apt install -yqq zsh
    fi
else
    log "zsh already installed"
fi

# Ensure less is installed for the git pager
if ! command -v less &> /dev/null; then
    log "Installing less..."
    if [ "$OS" = "darwin" ]; then
        brew install less
    elif [ "$OS" = "alpine" ]; then
        apk add --no-cache less
    else
        sudo apt update -yqq
        sudo apt install -yqq less
    fi
else
    log "less already installed"
fi

# ------------------------------------------------------------
# AWS CLI v2
# ------------------------------------------------------------
log "Installing AWS CLI v2..."

TMP_DIR="$(mktemp -d)"
cd "$TMP_DIR"

if [ "$OS" = "darwin" ]; then
    detect_arch
    curl -fsSLo AWSCLIV2.pkg "https://awscli.amazonaws.com/AWSCLIV2.pkg"
    sudo installer -pkg AWSCLIV2.pkg -target /
elif [ "$OS" = "alpine" ]; then
    apk add --no-cache aws-cli
else
    detect_arch

    curl -fsSLo awscliv2.zip \
      "https://awscli.amazonaws.com/awscli-exe-linux-${AWS_ARCH}.zip"

    unzip -q awscliv2.zip
    ./aws/install --update
fi

cd /
rm -rf "$TMP_DIR"

aws --version

# Install the AWS Session Manager Plugin
if ! command -v session-manager-plugin >/dev/null 2>&1; then
    log "Installing AWS Session Manager Plugin..."
    if [ "$OS" = "darwin" ]; then
        brew install --force session-manager-plugin || true
    elif [ "$OS" = "alpine" ]; then
        apk add --no-cache aws-session-manager-plugin
    else
        detect_arch

        SESSION_MANAGER_URL="https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_${target}/session-manager-plugin.deb"
        wget -qq "$SESSION_MANAGER_URL" -P "/tmp"
        sudo dpkg -i /tmp/session-manager-plugin.deb
        rm /tmp/session-manager-plugin.deb
    fi
else
    log "AWS Session Manager Plugin is already installed"
fi

# Install Docker ECR Credential Helper
if ! command -v docker-credential-ecr-login &> /dev/null; then
    log "Installing Docker ECR Credential Helper..."
    
    # Detect architecture
    detect_arch
    
    # Map OS to S3 format
    if [ "$OS" = "darwin" ]; then
        ecr_os="darwin"
    elif [ "$OS" = "alpine" ] || [ "$OS" = "linux" ]; then
        ecr_os="linux"
    else
        log "Unsupported OS: ${OS}"
        exit 1
    fi
    
    # ECR Credential Helper version
    ECR_CRED_HELPER_VERSION="0.11.0"
    
    # Download binary from S3
    ECR_URL="https://amazon-ecr-credential-helper-releases.s3.us-east-2.amazonaws.com/${ECR_CRED_HELPER_VERSION}/${ecr_os}-${ecr_arch}/docker-credential-ecr-login"
    TMP_BINARY="/tmp/docker-credential-ecr-login"
    
    log "Downloading Docker ECR Credential Helper for ${ecr_os}-${ecr_arch}..."
    curl -fSL "$ECR_URL" -o "$TMP_BINARY"
    
    # Make executable and install
    chmod +x "$TMP_BINARY"
    if [ "$OS" = "darwin" ]; then
        sudo mv "$TMP_BINARY" "/usr/local/bin/docker-credential-ecr-login"
    else
        sudo mv "$TMP_BINARY" "/usr/local/bin/docker-credential-ecr-login"
    fi
    
    log "Docker ECR Credential Helper installed successfully"
else
    log "Docker ECR Credential Helper is already installed"
fi

# Copy dotfiles to home directory
log "Copying dotfiles to home directory..."

# Create backup of existing files if they exist
if [ -f "$HOME/.zshrc" ]; then
    mv "$HOME/.zshrc" "$HOME/.zshrc.backup"
    log "Backed up existing .zshrc"
fi

if [ -f "$HOME/.zsh_plugins.txt" ]; then
    mv "$HOME/.zsh_plugins.txt" "$HOME/.zsh_plugins.txt.backup" 
    log "Backed up existing .zsh_plugins.txt"
fi

if [ -f "$HOME/.p10k.zsh" ]; then
    mv "$HOME/.p10k.zsh" "$HOME/.p10k.zsh.backup"
    log "Backed up existing .p10k.zsh"
fi

if [ -f "$HOME/.tmux.conf" ]; then
    mv "$HOME/.tmux.conf" "$HOME/.tmux.conf.backup"
    log "Backed up existing .tmux.conf"
fi

# Copy new files
log "Installing/symlinking zsh configuration files..."
ln -sfn "$REPO_DIR/zsh/.zshrc" "$HOME/.zshrc"
ln -sfn "$REPO_DIR/zsh/.zsh_plugins.txt" "$HOME/.zsh_plugins.txt"
ln -sfn "$REPO_DIR/zsh/.p10k.zsh" "$HOME/.p10k.zsh"
ln -sfn "$REPO_DIR/tmux/.tmux.conf" "$HOME/.tmux.conf"

# Copy code/cursor commands
# echo "Installing code and cursor commands..."
# if [ "$OS" = "darwin" ]; then
#     sudo cp "./zsh/cmd/code" "/usr/local/bin/code"
#     sudo cp "./zsh/cmd/code" "/usr/local/bin/cursor"
#     sudo chmod +x "/usr/local/bin/code" "/usr/local/bin/cursor"
# else
#     cp "./zsh/cmd/code" "/usr/local/bin/code"
#     cp "./zsh/cmd/code" "/usr/local/bin/cursor"
#     chmod +x "/usr/local/bin/code" "/usr/local/bin/cursor"
# fi

# Copy docker config for non-macOS systems
if [ "$OS" != "darwin" ]; then
    mkdir -p "$HOME/.docker"
    if [ -f "$HOME/.docker/config.json" ]; then
        mv "$HOME/.docker/config.json" "$HOME/.docker/config.json.backup"
        log "Backed up existing docker config json"
    fi

    ln -sfn "$REPO_DIR/docker/config.json" "$HOME/.docker/config.json"
    log "Installed/symlinked ~/.docker/config.json"
fi

log "Dotfiles installation completed successfully!"
log "Please restart your shell or run 'exec zsh' to apply changes."
