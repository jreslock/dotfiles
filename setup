#!/usr/bin/env bash

# This script sets up the environment in a new development container.
# It installs Antidote, zsh, less, unzip, the GitHub CLI (gh), AWS CLI v2,
# AWS Session Manager Plugin, and Git Credential Manager.

# Exit on any error
set -euo pipefail

log() { echo "[$(date -Is)] $*"; }

# Enforce running from the dotfiles repo dir only
if [ "$(pwd)" != "dotfiles" ]; then
  log "Please run from the root of the dotfiles repository"
  exit 1
fi

# Detect OS
OS=$(uname -s | tr '[:upper:]' '[:lower:]')

# Detect if the system is Alpine Linux
if [ -f /etc/alpine-release ]; then
    OS="alpine"
fi

echo "Detected OS: $OS"

# ------------------------------------------------------------
# uv (Astral)
# ------------------------------------------------------------
log "Installing uv..."
curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR=/usr/local/bin sh

# Install Antidote
echo "Installing Antidote..."
if [ ! -d "${HOME}/.antidote" ]; then
  git clone --depth=1 https://github.com/mattmc3/antidote.git "${HOME}/.antidote"
  echo "Antidote installed successfully"
else
    echo "Antidote already installed, updating..."
    cd "${HOME}/.antidote" && git pull --quiet && cd - > /dev/null
fi

# Install zsh
if ! command -v zsh &> /dev/null; then
    echo "Installing zsh..."
    if [ "$OS" = "darwin" ]; then
        brew install zsh
    elif [ "$OS" = "alpine" ]; then
        apk add --no-cache zsh
    else
        apt update -yqq
        apt install -yqq zsh
    fi
else
    echo "zsh already installed"
fi

# Ensure less is installed for the git pager
if ! command -v less &> /dev/null; then
    echo "Installing less..."
    if [ "$OS" = "darwin" ]; then
        brew install less
    elif [ "$OS" = "alpine" ]; then
        apk add --no-cache less
    else
        apt update -yqq
        apt install -yqq less
    fi
else
    echo "less already installed"
fi

# ------------------------------------------------------------
# AWS CLI v2
# ------------------------------------------------------------
log "Installing AWS CLI v2..."

TMP_DIR="$(mktemp -d)"
cd "$TMP_DIR"

curl -fsSLo awscliv2.zip \
  "https://awscli.amazonaws.com/awscli-exe-linux-${AWS_ARCH}.zip"

unzip -q awscliv2.zip
./aws/install --update

cd /
rm -rf "$TMP_DIR"

aws --version

# Install the AWS Session Manager Plugin
if ! command -v session-manager-plugin &> /dev/null; then
    echo "Installing AWS Session Manager Plugin..."
    if [ "$OS" = "darwin" ]; then
        brew install session-manager-plugin
    elif [ "$OS" = "alpine" ]; then
        apk add --no-cache aws-session-manager-plugin
    else
        ARCH=$(uname -m)
        if [ "$ARCH" = "x86_64" ] || [ "$ARCH" = "amd64" ]; then
            target="64bit"
        elif [ "$ARCH" = "arm64" ] || [ "$ARCH" = "aarch64" ]; then
            target="arm64"
        else
            echo "Unsupported architecture: ${ARCH}"
            exit 1
        fi

        SESSION_MANAGER_URL="https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_${target}/session-manager-plugin.deb"
        wget -qq "$SESSION_MANAGER_URL" -P "/tmp"
        dpkg -i /tmp/session-manager-plugin.deb
        rm /tmp/session-manager-plugin.deb
    fi
else
    echo "AWS Session Manager Plugin is already installed"
fi

# Install Docker ECR Credential Helper
if ! command -v docker-credential-ecr-login &> /dev/null; then
    echo "Installing Docker ECR Credential Helper..."
    
    # Detect architecture
    ARCH=$(uname -m)
    if [ "$ARCH" = "x86_64" ] || [ "$ARCH" = "amd64" ]; then
        ecr_arch="amd64"
    elif [ "$ARCH" = "arm64" ] || [ "$ARCH" = "aarch64" ]; then
        ecr_arch="arm64"
    else
        echo "Unsupported architecture: ${ARCH}"
        exit 1
    fi
    
    # Map OS to S3 format
    if [ "$OS" = "darwin" ]; then
        ecr_os="darwin"
    elif [ "$OS" = "alpine" ] || [ "$OS" = "linux" ]; then
        ecr_os="linux"
    else
        echo "Unsupported OS: ${OS}"
        exit 1
    fi
    
    # ECR Credential Helper version
    ECR_CRED_HELPER_VERSION="0.11.0"
    
    # Download binary from S3
    ECR_URL="https://amazon-ecr-credential-helper-releases.s3.us-east-2.amazonaws.com/${ECR_CRED_HELPER_VERSION}/${ecr_os}-${ecr_arch}/docker-credential-ecr-login"
    TMP_BINARY="/tmp/docker-credential-ecr-login"
    
    echo "Downloading Docker ECR Credential Helper for ${ecr_os}-${ecr_arch}..."
    curl -fSL "$ECR_URL" -o "$TMP_BINARY"
    
    # Make executable and install
    chmod +x "$TMP_BINARY"
    if [ "$OS" = "darwin" ]; then
        sudo mv "$TMP_BINARY" "/usr/local/bin/docker-credential-ecr-login"
    else
        mv "$TMP_BINARY" "/usr/local/bin/docker-credential-ecr-login"
    fi
    
    echo "Docker ECR Credential Helper installed successfully"
else
    echo "Docker ECR Credential Helper is already installed"
fi

# Copy dotfiles to home directory
echo "Copying dotfiles to home directory..."

# Create backup of existing files if they exist
if [ -f "$HOME/.zshrc" ]; then
    mv "$HOME/.zshrc" "$HOME/.zshrc.backup"
    echo "Backed up existing .zshrc"
fi

if [ -f "$HOME/.zsh_plugins.txt" ]; then
    mv "$HOME/.zsh_plugins.txt" "$HOME/.zsh_plugins.txt.backup" 
    echo "Backed up existing .zsh_plugins.txt"
fi

if [ -f "$HOME/.p10k.zsh" ]; then
    mv "$HOME/.p10k.zsh" "$HOME/.p10k.zsh.backup"
    echo "Backed up existing .p10k.zsh"
fi

# Copy new files
echo "Installing/symlinking zsh configuration files..."
ln -s "$(pwd)/zsh/.zshrc" "$HOME/.zshrc"
ln -s "$(pwd)/zsh/.zsh_plugins.txt" "$HOME/.zsh_plugins.txt"
ln -s "$(pwd)/zsh/.p10k.zsh" "$HOME/.p10k.zsh"
ln -s "$(pwd)/tmux/.tmux.conf" "$HOME/.tmux.conf"

# Copy code/cursor commands
# echo "Installing code and cursor commands..."
# if [ "$OS" = "darwin" ]; then
#     sudo cp "./zsh/cmd/code" "/usr/local/bin/code"
#     sudo cp "./zsh/cmd/code" "/usr/local/bin/cursor"
#     sudo chmod +x "/usr/local/bin/code" "/usr/local/bin/cursor"
# else
#     cp "./zsh/cmd/code" "/usr/local/bin/code"
#     cp "./zsh/cmd/code" "/usr/local/bin/cursor"
#     chmod +x "/usr/local/bin/code" "/usr/local/bin/cursor"
# fi

# Copy docker config for non-macOS systems
if [ "$OS" != "darwin" ]; then
    mkdir -p "$HOME/.docker"
    ln -s "$(pwd)/docker/config.json" "$HOME/.docker/config.json"
    echo "Installed/symlinked ~/.docker/config.json"
fi

echo "Dotfiles installation completed successfully!"
echo "Please restart your shell or run 'source ~/.zshrc' to apply changes."
